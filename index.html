<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magic Fairy Tales Library</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Quicksand:wght@500;700&family=Lora:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    
    <!-- Link to your stylesheet -->
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <!-- Background Shapes -->
    <div class="bg-shape shape-1"></div>
    <div class="bg-shape shape-2"></div>
    <div class="bg-shape shape-3"></div>

    <!-- LIBRARY VIEW -->
    <div id="library-view">
        <header>
            <h1>üè∞ Magic Fairy Tales üè∞</h1>
            <div class="search-bar">
                <span class="search-icon">üîé</span>
                <input type="text" id="search-input" placeholder="What story shall we read?">
            </div>
        </header>

        <div id="gallery-grid" class="grid"></div>
        <p id="loading-msg" style="margin-top:20px; font-family:'Quicksand'; font-size:1.2rem;">‚ú® Summoning stories... ‚ú®</p>
    </div>

    <!-- READER VIEW -->
    <div id="reader-view" class="hidden">
        <div class="top-controls">
            <button id="watch-btn" class="control-btn video-btn hidden" onclick="openVideo()">
                <span>üì∫</span> Watch Movie
            </button>
            <button class="control-btn close-btn" onclick="closeBook()">
                <span>‚úñ</span> Close
            </button>
        </div>
        
        <div class="nav-arrow prev" onclick="flipPrev()">
            <svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"></path></svg>
        </div>
        <div class="nav-arrow next" onclick="flipNext()">
            <svg viewBox="0 0 24 24"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"></path></svg>
        </div>

        <div class="book-stage">
            <div id="flip-book"></div>
        </div>

        <div id="audio-controls" class="hidden">
            <div class="audio-title">üéß Listen Together</div>
            <audio id="audio-player" controls controlsList="nodownload"></audio>
        </div>
    </div>

    <!-- VIDEO MODAL -->
    <div id="video-modal" class="hidden">
        <div class="video-container">
            <div id="yt-player-container"></div>
        </div>
        <button class="close-video-btn" onclick="closeVideo()">Close Video</button>
    </div>

    <!-- External Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/js/page-flip.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2/dist/fuse.min.js"></script>

    <script>
        // Global State Variables
        let allTales = [];
        let bookInstance = null;
        let isMobile = window.innerWidth <= 768;
        let currentVideoId = null;
        let currentSyncData = [];

        // Handle Resize
        window.addEventListener('resize', () => {
            const newIsMobile = window.innerWidth <= 768;
            if (newIsMobile !== isMobile) {
                isMobile = newIsMobile;
                // Reload if reader is open to reset PageFlip dimensions
                if (!document.getElementById('reader-view').classList.contains('hidden')) {
                    location.reload();
                }
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadTales();
        });

        // Load Tales Data
        async function loadTales() {
            try {
                // Try to fetch tales-index.json
                const res = await fetch('/tales-index.json');
                if(!res.ok) throw new Error("No index file found");
                allTales = await res.json();
                renderLibrary(allTales);
            } catch(e) {
                console.warn("Using internal demo data due to fetch error:", e);
                
                // DEMO DATA (The Three Bears)
                allTales = [
                    {
                        id: 'demo_bears', 
                        title: 'Goldilocks & 3 Bears', 
                        author: 'Folklore', 
                        cover: 'https://cdn.pixabay.com/photo/2023/05/29/18/59/bear-8026958_1280.jpg',
                        audio: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3', // Placeholder Audio
                        youtube: '', 
                        content: [
                            {
                                text: "Once upon a time, in a cozy little house at the edge of a great, whispering forest, there lived three bears‚Äîa great big Papa Bear, a middle-sized Mama Bear, and a tiny, wee little Baby Bear.",
                                side: "left",
                                start: 0.0,
                                end: 14.8,
                                image: "https://cdn.pixabay.com/photo/2020/06/15/18/06/bears-5302684_1280.jpg",
                                words: [
                                    {"w": "Once", "s": 0.0, "e": 0.32},
                                    {"w": "upon", "s": 0.32, "e": 0.6},
                                    {"w": "a",    "s": 0.6, "e": 0.8},
                                    {"w": "time,", "s": 0.8, "e": 1.12},
                                    {"w": "in", "s": 1.12, "e": 1.5},
                                    {"w": "a", "s": 1.5, "e": 1.8},
                                    {"w": "cozy", "s": 1.8, "e": 2.2},
                                    {"w": "little", "s": 2.2, "e": 2.8},
                                    {"w": "house", "s": 2.8, "e": 3.2}
                                ]
                            },
                            {
                                text: "They were a happy family, and every morning, they would sit down together to enjoy a steaming bowl of porridge for breakfast.",
                                side: "right",
                                start: 14.8, 
                                end: 24.0,
                                image: "https://cdn.pixabay.com/photo/2023/10/05/17/54/bear-8296342_1280.jpg",
                                words: [
                                    {"w": "They", "s": 14.8, "e": 15.2},
                                    {"w": "were", "s": 15.2, "e": 15.5},
                                    {"w": "a", "s": 15.5, "e": 15.8},
                                    {"w": "happy", "s": 15.8, "e": 16.5},
                                    {"w": "family,", "s": 16.5, "e": 17.5}
                                ]
                            },
                            {
                                text: "One morning, Mama Bear stirred the porridge in her big pot and said, \"Oh dear, this porridge is much too hot to eat! Let‚Äôs take a walk in the forest while it cools.\"",
                                side: "right", 
                                start: 24.0, 
                                end: 36.0,
                                image: "https://cdn.pixabay.com/photo/2019/07/28/19/04/autumn-4369408_1280.jpg",
                                words: [
                                    {"w": "One", "s": 24.0, "e": 24.5},
                                    {"w": "morning,", "s": 24.5, "e": 25.0},
                                    {"w": "Mama", "s": 25.0, "e": 25.5},
                                    {"w": "Bear", "s": 25.5, "e": 26.0}
                                ]
                            }
                        ]
                    }
                ];
                renderLibrary(allTales);
            }
            document.getElementById('loading-msg').style.display = 'none';
            setupSearch();
            setupAudioSync();
        }

        // Render Library Grid
        function renderLibrary(tales) {
            const grid = document.getElementById('gallery-grid');
            grid.innerHTML = '';
            
            tales.forEach(tale => {
                const div = document.createElement('div');
                div.className = 'tile';
                
                // Handle local vs remote images
                const imgUrl = tale.cover && !tale.cover.startsWith('http') 
                    ? `/tales/${tale.id}/${tale.cover}` 
                    : (tale.cover || 'https://via.placeholder.com/300x450?text=No+Cover');
                
                let badges = '';
                if (tale.audio) badges += '<div class="badge" title="Audio">üéµ</div>';
                if (tale.youtube) badges += '<div class="badge" title="Video">üé¨</div>';

                div.innerHTML = `
                    <img src="${imgUrl}">
                    <div class="media-badges">${badges}</div>
                    <h3>${tale.title}</h3>
                `;
                div.onclick = () => openBook(tale);
                grid.appendChild(div);
            });
        }

        // Search Functionality
        function setupSearch() {
            const searchInput = document.getElementById('search-input');
            searchInput.addEventListener('input', (e) => {
                const query = e.target.value;
                if (!query) { renderLibrary(allTales); return; }
                const fuse = new Fuse(allTales, { keys: ['title', 'author'], threshold: 0.4 });
                renderLibrary(fuse.search(query).map(r => r.item));
            });
        }

        // --- CORE: AUDIO SYNC & HIGHLIGHTING ---
        function setupAudioSync() {
            const audioPlayer = document.getElementById('audio-player');
            let lastPageIndex = -1;

            audioPlayer.ontimeupdate = () => {
                const currentTime = audioPlayer.currentTime;
                
                // Use .filter() to find ALL pages active at this time (Left & Right)
                const activePages = currentSyncData.filter(block => currentTime >= block.start && currentTime < block.end);

                if (activePages.length > 0) {
                    
                    // 1. Page Turning Logic
                    // Use the first active page to determine if we need to flip
                    const primaryPage = activePages[0];
                    if (lastPageIndex !== primaryPage.pageIndex) {
                        lastPageIndex = primaryPage.pageIndex;
                        if (!isMobile && bookInstance) {
                            bookInstance.flip(primaryPage.pageIndex);
                        } else {
                            // Mobile scroll
                            const p = document.getElementById(`page-index-${primaryPage.pageIndex}`);
                            if(p) p.scrollIntoView({behavior:'smooth', block:'center'});
                        }
                    }

                    // 2. Word Highlighting Logic
                    // Iterate through ALL active pages (both left and right)
                    activePages.forEach(pageData => {
                        const activePageEl = document.getElementById(`page-index-${pageData.pageIndex}`);
                        if (activePageEl) {
                            const spans = activePageEl.querySelectorAll('.word-span');
                            spans.forEach(span => {
                                const start = parseFloat(span.dataset.s);
                                const end = parseFloat(span.dataset.e);
                                if (currentTime >= start && currentTime < end) {
                                    span.classList.add('word-active');
                                } else {
                                    span.classList.remove('word-active');
                                }
                            });
                        }
                    });
                }
            }
        }

        // --- BOOK OPENING LOGIC ---
        function openBook(tale) {
            document.getElementById('library-view').classList.add('hidden');
            document.getElementById('reader-view').classList.remove('hidden');

            const stage = document.querySelector('.book-stage');
            const oldBook = document.getElementById('flip-book');
            if (oldBook) oldBook.remove();

            const bookEl = document.createElement('div');
            bookEl.id = 'flip-book';
            stage.appendChild(bookEl);

            if (bookInstance) { bookInstance.destroy(); bookInstance = null; }
            currentSyncData = [];

            const audioWrapper = document.getElementById('audio-controls');
            const audioPlayer = document.getElementById('audio-player');
            if (tale.audio) {
                const audioSrc = tale.audio.startsWith('http') ? tale.audio : `/tales/${tale.id}/${tale.audio}`;
                audioPlayer.src = audioSrc;
                audioWrapper.classList.remove('hidden');
            } else {
                audioWrapper.classList.add('hidden');
                audioPlayer.pause();
            }

            const videoBtn = document.getElementById('watch-btn');
            if (tale.youtube) {
                const videoId = getYoutubeID(tale.youtube);
                if (videoId) {
                    currentVideoId = videoId;
                    videoBtn.classList.remove('hidden');
                } else { videoBtn.classList.add('hidden'); }
            } else {
                videoBtn.classList.add('hidden');
                currentVideoId = null;
            }

            // --- GENERATE TITLE PAGE (Page 0) ---
            const titlePage = document.createElement('div');
            titlePage.className = 'page';
            titlePage.id = 'page-index-0';
            titlePage.innerHTML = `
                <div class="title-content">
                    <h1 style="font-family:'Fredoka', sans-serif; color:#6c5ce7; font-size:2.5rem; margin-top:50px;">${tale.title}</h1>
                    <p style="font-family:'Quicksand'; font-weight:bold; font-size:1.2rem; color:#b2bec3;">${tale.author || 'Folklore'}</p>
                    <div style="margin-top:auto; font-size:4rem;">ü¶Ñ</div>
                </div>`;
            bookEl.appendChild(titlePage);

            // --- GENERATE CONTENT PAGES ---
            if (tale.content) {
                tale.content.forEach((item, i) => {
                    const pageIndex = i + 1; // Start from 1 because 0 is title
                    const page = document.createElement('div');
                    page.className = 'page';
                    page.id = `page-index-${pageIndex}`;

                    // Store sync data
                    if (item.start !== undefined) {
                        currentSyncData.push({
                            pageIndex: pageIndex,
                            start: parseFloat(item.start),
                            end: parseFloat(item.end)
                        });
                    }

                    const img = item.image && !item.image.startsWith('http') ? `/tales/${tale.id}/${item.image}` : item.image;
                    
                    // Generate Word Spans
                    let textHtml = '';
                    if (item.words && item.words.length > 0) {
                        // CRITICAL FIX: .join(' ') with a space to prevent stuck words
                        textHtml = item.words.map(w => 
                            `<span class="word-span" data-s="${w.s}" data-e="${w.e}">${w.w}</span>`
                        ).join(' '); 
                    } else {
                        textHtml = item.text || '';
                    }

                    // Flexbox Layout: Image container top (2/3), Text container bottom (1/3)
                    page.innerHTML = `
                        <div class="page-content">
                            ${img ? `<div class="page-img-box"><img src="${img}"></div>` : '<div class="page-img-box"></div>'}
                            <div class="page-text">${textHtml}</div>
                            <div class="page-footer">${pageIndex}</div>
                        </div>
                    `;
                    bookEl.appendChild(page);
                });
            }

            // Add empty page if odd number (for proper book closing on desktop)
            if (bookEl.children.length % 2 !== 0 && !isMobile) {
                const emptyPage = document.createElement('div');
                emptyPage.className = 'page';
                bookEl.appendChild(emptyPage);
            }

            // Initialize PageFlip Library
            if (!isMobile) {
                const PageFlip = window.St ? window.St.PageFlip : window.PageFlip;
                bookInstance = new PageFlip(bookEl, {
                    width: 550, height: 750,
                    size: 'fixed', usePortrait: false,
                    minWidth: 300, minHeight: 400,
                    maxShadowOpacity: 0.5, showCover: false
                });
                bookInstance.loadFromHTML(bookEl.querySelectorAll('.page'));
            }
        }

        function getYoutubeID(url) {
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        }

        function openVideo() {
            if (!currentVideoId) return;
            document.getElementById('audio-player').pause();
            const modal = document.getElementById('video-modal');
            const container = document.getElementById('yt-player-container');
            container.innerHTML = `
                <iframe src="https://www.youtube.com/embed/${currentVideoId}?autoplay=1" 
                frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                allowfullscreen></iframe>
            `;
            modal.classList.remove('hidden');
        }

        function closeVideo() {
            const modal = document.getElementById('video-modal');
            const container = document.getElementById('yt-player-container');
            modal.classList.add('hidden');
            container.innerHTML = '';
        }

        function closeBook() {
            document.getElementById('reader-view').classList.add('hidden');
            document.getElementById('library-view').classList.remove('hidden');
            
            const audioPlayer = document.getElementById('audio-player');
            audioPlayer.pause();
            audioPlayer.currentTime = 0;
            currentSyncData = [];

            if (bookInstance) { bookInstance.destroy(); bookInstance = null; }
            const oldBook = document.getElementById('flip-book');
            if (oldBook) oldBook.remove();
        }

        function flipNext() { if(!isMobile) bookInstance?.flipNext(); }
        function flipPrev() { if(!isMobile) bookInstance?.flipPrev(); }
    </script>
</body>
</html>
