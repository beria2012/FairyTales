<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Royal Fairy Tales Library</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700;900&family=Cormorant+Garamond:ital,wght@0,500;0,700;1,500&family=Henny+Penny&display=swap" rel="stylesheet">
    
    <!-- Icon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üè∞</text></svg>">

    <!-- Styles (CSS) -->
    <style>
        :root {
            --deep-sky: #090e18;
            --night-purple: #1a0b2e;
            --gold-glow: #ffd700;
            --gold-dark: #b8860b;
            --parchment: #f4e4bc;
            --wood-dark: #3e2723;
            --wood-light: #5d4037;
            --book-red: #8a1c1c;
            --text-main: #2b1d0e;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Cormorant Garamond', serif;
            background-color: var(--deep-sky);
            color: #fff;
            min-height: 100vh;
            overflow-x: hidden;
            cursor: none;
        }

        *, *::before, *::after { box-sizing: border-box; }

        /* --- MAGIC CURSOR --- */
        .cursor-dot, .cursor-outline {
            position: fixed; top: 0; left: 0; transform: translate(-50%, -50%);
            border-radius: 50%; z-index: 9999; pointer-events: none;
        }
        .cursor-dot { width: 8px; height: 8px; background: var(--gold-glow); box-shadow: 0 0 15px var(--gold-glow); }
        .cursor-outline { width: 40px; height: 40px; border: 2px solid rgba(255, 215, 0, 0.5); transition: width 0.2s, height 0.2s; }

        /* --- BACKGROUND --- */
        .world-bg { position: fixed; width: 100%; height: 100%; z-index: -1; background: linear-gradient(to bottom, #05081c 0%, #1a0b2e 100%); overflow: hidden; }
        .stars { position: absolute; width: 100%; height: 100%; background: url('https://www.transparenttextures.com/patterns/stardust.png'); opacity: 0.8; }
        .clouds { position: absolute; top: 10%; width: 300%; height: 100%; background: url('https://raw.githubusercontent.com/yemon/react-parallax-scrolling/master/demo/src/images/cloud.png') repeat-x; background-size: contain; opacity: 0.15; animation: drift 120s linear infinite; }
        .castle-silhouette { position: absolute; bottom: 0; width: 100%; height: 50%; background-image: url('https://i.ibb.co/3Wrq1gq/castle-silhouette.png'); background-repeat: no-repeat; background-position: bottom center; background-size: contain; opacity: 0.4; }
        .fog { position: absolute; bottom: 0; width: 100%; height: 30%; background: linear-gradient(to top, var(--night-purple), transparent); }
        @keyframes drift { from { transform: translateX(0); } to { transform: translateX(-50%); } }

        /* --- UI ELEMENTS --- */
        header { text-align: center; padding-top: 50px; z-index: 10; position: relative; }
        .logo-area h1 { font-family: 'Cinzel Decorative', cursive; font-size: 5rem; color: var(--gold-glow); text-shadow: 0 0 10px rgba(255, 215, 0, 0.5); margin: 10px 0; }
        .crown-icon { font-size: 4rem; animation: float 3s infinite; }
        
        .search-scroll {
            background: var(--parchment);
            padding: 15px 40px; border-radius: 60px; border: 4px solid var(--wood-dark);
            display: flex; align-items: center; width: 100%; max-width: 550px; margin: 40px auto 0;
            transform: rotate(-1.5deg); transition: 0.4s;
            background-image: url('https://www.transparenttextures.com/patterns/aged-paper.png');
        }
        .search-scroll:focus-within { transform: rotate(0) scale(1.05); border-color: var(--gold-dark); }
        .search-scroll input { border: none; background: transparent; width: 100%; font-family: 'Henny Penny', cursive; font-size: 1.6rem; color: #3e2723; outline: none; text-align: center; }

        /* --- BOOKS GRID --- */
        .shelves { display: grid; grid-template-columns: repeat(auto-fill, minmax(230px, 1fr)); gap: 90px 40px; margin: 60px auto; max-width: 1200px; padding: 0 20px; }
        
        .book-card { position: relative; width: 230px; height: 340px; perspective: 1500px; cursor: pointer; margin: 0 auto; transition: transform 0.4s; }
        .book-card:hover { transform: translateY(-20px) scale(1.02); z-index: 10; }
        
        .book-cover {
            width: 100%; height: 100%; border-radius: 4px 12px 12px 4px;
            box-shadow: inset 5px 0 10px rgba(0,0,0,0.4), 15px 20px 30px rgba(0,0,0,0.6);
            background-size: cover; background-position: center; border-left: 14px solid rgba(0,0,0,0.3);
            display: flex; flex-direction: column; justify-content: flex-end; overflow: hidden;
        }
        .book-info { background: linear-gradient(to top, rgba(15, 5, 20, 0.95), transparent); padding: 30px 15px 15px; text-align: center; }
        .book-info h3 { margin: 0; color: var(--gold-glow); font-family: 'Cinzel Decorative', cursive; text-shadow: 0 2px 4px #000; }
        
        .pages-edge {
            position: absolute; top: 6px; right: -12px; width: 12px; height: 96%;
            background: linear-gradient(to right, #fdfbf0, #ccc 100%);
            border-radius: 0 4px 4px 0; transform: rotateY(90deg); transform-origin: left;
        }

        /* --- READER --- */
        .reader-overlay { position: fixed; inset: 0; background: rgba(5, 3, 10, 0.9); z-index: 100; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(15px); }
        .wood-frame { width: 95%; height: 90%; max-width: 1400px; background: var(--wood-dark) url('https://www.transparenttextures.com/patterns/wood-pattern.png'); border-radius: 20px; position: relative; display: flex; flex-direction: column; align-items: center; padding: 20px; border: 4px solid var(--gold-dark); }
        
        .btn-magic { background: var(--book-red); color: #ffecb3; border: 2px solid var(--gold-dark); padding: 12px 30px; border-radius: 30px; font-family: 'Henny Penny', cursive; font-size: 1.3rem; cursor: pointer; margin-bottom: 20px; }
        
        .book-stage { flex-grow: 1; display: flex; align-items: center; justify-content: center; width: 100%; }
        
        .page { background: var(--parchment); border: 1px solid #d4c5a3; overflow: hidden; box-shadow: inset 0 0 40px rgba(62, 39, 35, 0.2); }
        .page-image { width: 100%; height: 100%; object-fit: contain; mix-blend-mode: multiply; padding: 10px; }
        .page-number { position: absolute; bottom: 10px; width: 100%; text-align: center; color: var(--wood-dark); font-family: 'Cinzel Decorative'; }

        .magic-player { background: rgba(26, 11, 46, 0.85); border: 2px solid var(--gold-glow); border-radius: 50px; padding: 10px 30px; display: flex; align-items: center; gap: 20px; margin-top: 10px; }
        .magic-player p { margin: 0; color: var(--gold-glow); font-family: 'Cinzel Decorative'; }
        
        .hidden { display: none !important; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }
    </style>
</head>
<body>
    <div class="cursor-dot"></div><div class="cursor-outline"></div>

    <div id="app">
        <div class="world-bg">
            <div class="stars"></div><div class="clouds"></div><div class="castle-silhouette"></div><div class="fog"></div>
        </div>

        <div id="library-view" class="container">
            <header>
                <div class="logo-area">
                    <div class="crown-icon">üëë</div>
                    <h1>Royal Fairy Tales</h1>
                </div>
                <div class="search-wrapper">
                    <div class="search-scroll">
                        <span>‚ú®</span>
                        <input type="text" id="search-input" placeholder="Whisper a story name here...">
                    </div>
                </div>
            </header>
            
            <div id="books-grid" class="shelves"></div>
            
            <div id="empty-state" class="hidden" style="text-align:center; margin-top:50px;">
                <div class="search-scroll" style="transform:none; flex-direction:column; gap:10px;">
                    <p style="color:#3e2723; font-family:'Henny Penny'; font-size:1.5rem;">The library is empty...</p>
                    <p style="color:#5d4037;">Add folders to <b>public/tales/</b></p>
                </div>
            </div>
        </div>

        <div id="reader-view" class="reader-overlay hidden">
            <div class="wood-frame">
                <button id="close-btn" class="btn-magic">üîô Return to Library</button>
                <div class="book-stage">
                    <div id="flip-book"></div>
                </div>
                <div id="audio-bar" class="hidden magic-player">
                    <span>ü¶Å</span>
                    <div>
                        <p>Storyteller</p>
                        <audio id="audio-player" controls></audio>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/js/page-flip.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2/dist/fuse.min.js"></script>

    <script type="module">
        let allTales = [];
        let pageFlipInstance = null;

        document.addEventListener('DOMContentLoaded', () => {
            init();
            initCursor();
        });

        async function init() {
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π JSON —Ñ–∞–π–ª
                const response = await fetch('/tales-index.json');
                
                if (!response.ok) {
                    throw new Error('Index file not found (Run npm run scan)');
                }
                
                allTales = await response.json();
                renderLibrary(allTales);
                setupSearch();
            } catch (e) {
                console.warn("Could not load tales:", e);
                document.getElementById('empty-state').classList.remove('hidden');
            }
        }

        function renderLibrary(tales) {
            const grid = document.getElementById('books-grid');
            const emptyState = document.getElementById('empty-state');
            grid.innerHTML = '';
            
            if (!tales || tales.length === 0) {
                emptyState.classList.remove('hidden');
                return;
            } else {
                emptyState.classList.add('hidden');
            }

            tales.forEach((tale, index) => {
                const colors = ['#8a1c1c', '#1c3b8a', '#1c8a45', '#4a1c8a', '#5d4037'];
                const randomColor = colors[index % colors.length];
                const card = document.createElement('div');
                card.className = 'book-card';
                
                // –§–æ—Ä–º–∏—Ä—É–µ–º –ø—É—Ç—å
                const coverUrl = tale.cover 
                    ? (tale.cover.startsWith('http') ? tale.cover : `/tales/${tale.id}/${tale.cover}`)
                    : '';

                const coverStyle = coverUrl ? `background-image: url('${coverUrl}')` : `background-color: ${randomColor}`;

                card.innerHTML = `
                    <div class="book-cover" style="${coverStyle}">
                        <div class="book-info">
                            <h3>${tale.title}</h3>
                            <p>${tale.author || 'Folklore'}</p>
                        </div>
                    </div>
                    <div class="pages-edge"></div>
                `;
                
                card.style.animation = `float 6s ease-in-out ${index * 0.3}s infinite`;
                card.onclick = () => openBook(tale);
                grid.appendChild(card);
            });
        }

        function setupSearch() {
            const searchInput = document.getElementById('search-input');
            searchInput.addEventListener('input', (e) => {
                const query = e.target.value;
                if (!query) return renderLibrary(allTales);
                const fuse = new Fuse(allTales, { keys: ['title', 'author'], threshold: 0.4 });
                renderLibrary(fuse.search(query).map(r => r.item));
            });
        }

        async function openBook(tale) {
            document.getElementById('library-view').classList.add('hidden');
            document.getElementById('reader-view').classList.remove('hidden');

            const audioBar = document.getElementById('audio-bar');
            const audioPlayer = document.getElementById('audio-player');
            
            if (tale.audio) {
                audioBar.classList.remove('hidden');
                audioPlayer.src = tale.audio.startsWith('http') ? tale.audio : `/tales/${tale.id}/${tale.audio}`;
            } else {
                audioBar.classList.add('hidden');
                audioPlayer.pause();
            }

            const bookEl = document.getElementById('flip-book');
            if (pageFlipInstance) { pageFlipInstance.destroy(); pageFlipInstance = null; }
            bookEl.innerHTML = ''; 

            if (Array.isArray(tale.pages)) {
                tale.pages.forEach((pageFile, i) => {
                    const div = document.createElement('div');
                    div.className = 'page';
                    const imgSrc = `/tales/${tale.id}/${pageFile}`;
                    div.innerHTML = `<img src="${imgSrc}" class="page-image" loading="lazy"><div class="page-number">- ${i + 1} -</div>`;
                    bookEl.appendChild(div);
                });
            } else {
                // Fallback –¥–ª—è —Å—Ç–∞—Ä–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞
                for(let i=1; i<= (tale.pages || 4); i++) {
                    const div = document.createElement('div');
                    div.className = 'page';
                    div.innerHTML = `<div class="page-number">Page ${i}</div>`;
                    bookEl.appendChild(div);
                }
            }

            const PageFlip = window.St ? window.St.PageFlip : window.PageFlip;
            pageFlipInstance = new PageFlip(bookEl, {
                width: 400, height: 600, size: 'fixed',
                drawShadow: true, showCover: true, usePortrait: true
            });
            pageFlipInstance.loadFromHTML(document.querySelectorAll('.page'));
        }

        document.getElementById('close-btn').onclick = () => {
            document.getElementById('reader-view').classList.add('hidden');
            document.getElementById('library-view').classList.remove('hidden');
            document.getElementById('audio-player').pause();
            if (pageFlipInstance) { pageFlipInstance.destroy(); pageFlipInstance = null; }
        };

        function initCursor() {
            const dot = document.querySelector('.cursor-dot');
            const outline = document.querySelector('.cursor-outline');
            if (window.matchMedia("(pointer: coarse)").matches) {
                dot.style.display = 'none'; outline.style.display = 'none'; document.body.style.cursor = 'auto'; return;
            }
            window.addEventListener('mousemove', (e) => {
                dot.style.left = `${e.clientX}px`; dot.style.top = `${e.clientY}px`;
                outline.animate({ left: `${e.clientX}px`, top: `${e.clientY}px` }, { duration: 500, fill: "forwards" });
            });
        }
    </script>
</body>
</html>
