<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magic Fairy Tales Library</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Quicksand:wght@500;700&family=Lora:ital,wght@0,400;0,500;0,600;1,400&display=swap" rel="stylesheet">
    
    <!-- Link to your CSS file -->
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <!-- Background Decorations -->
    <div class="bg-shape shape-1"></div>
    <div class="bg-shape shape-2"></div>
    <div class="bg-shape shape-3"></div>

    <!-- VIEW 1: LIBRARY (Grid of Books) -->
    <div id="library-view">
        <header>
            <h1>üè∞ Magic Fairy Tales üè∞</h1>
            <div class="search-bar">
                <span class="search-icon">üîé</span>
                <input type="text" id="search-input" placeholder="What story shall we read?">
            </div>
        </header>

        <div id="gallery-grid" class="grid"></div>
        <p id="loading-msg" style="margin-top:20px; font-family:'Quicksand'; font-size:1.2rem;">‚ú® Summoning stories... ‚ú®</p>
    </div>

    <!-- VIEW 2: READER (The Book) -->
    <div id="reader-view" class="hidden">
        <!-- Top Buttons -->
        <div class="top-controls">
            <button id="watch-btn" class="control-btn video-btn hidden" onclick="openVideo()">
                <span>üì∫</span> Watch Movie
            </button>
            <button class="control-btn close-btn" onclick="closeBook()">
                <span>‚úñ</span> Close
            </button>
        </div>
        
        <!-- Navigation Arrows -->
        <div class="nav-arrow prev" onclick="flipPrev()">
            <svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"></path></svg>
        </div>
        <div class="nav-arrow next" onclick="flipNext()">
            <svg viewBox="0 0 24 24"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"></path></svg>
        </div>

        <!-- The Book Container -->
        <div class="book-stage">
            <div id="flip-book"></div>
        </div>

        <!-- Audio Player -->
        <div id="audio-controls" class="hidden">
            <div class="audio-title">üéß Listen Together</div>
            <audio id="audio-player" controls controlsList="nodownload"></audio>
        </div>
    </div>

    <!-- VIDEO POPUP (Modal) -->
    <div id="video-modal" class="hidden">
        <div class="video-container">
            <div id="yt-player-container"></div>
        </div>
        <button class="close-video-btn" onclick="closeVideo()">Close Video</button>
    </div>

    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/js/page-flip.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2/dist/fuse.min.js"></script>

    <!-- Main Logic -->
    <script>
        let allTales = [];
        let bookInstance = null;
        let isMobile = window.innerWidth <= 768;
        let currentVideoId = null;
        let currentSyncData = []; // Stores word timings for the active book

        // Handle window resize
        window.addEventListener('resize', () => {
            const newIsMobile = window.innerWidth <= 768;
            if (newIsMobile !== isMobile) {
                isMobile = newIsMobile;
                // Reload if reader is open to reset layout
                if (!document.getElementById('reader-view').classList.contains('hidden')) {
                    location.reload();
                }
            }
        });

        // Start app
        document.addEventListener('DOMContentLoaded', () => {
            loadTales();
        });

        // 1. Load Data
        async function loadTales() {
            try {
                // Try to fetch 'tales.json' from your server
                const res = await fetch('tales.json'); 
                if(!res.ok) throw new Error("No index file found");
                allTales = await res.json();
                renderLibrary(allTales);
            } catch(e) {
                console.warn("Using DEMO data because tales.json was not found.");
                
                // --- DEMO DATA ---
                allTales = [
                    {
                        id: 'demo_bears', 
                        title: 'Goldilocks & 3 Bears', 
                        author: 'Folklore', 
                        cover: 'https://cdn.pixabay.com/photo/2023/05/29/18/59/bear-8026958_1280.jpg',
                        audio: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3', // Example MP3
                        youtube: '', // Add YouTube URL here if needed
                        content: [
                            {
                                text: "Once upon a time, there were three bears who lived in a house in a forest.",
                                start: 0.0,
                                end: 10.0,
                                image: "https://cdn.pixabay.com/photo/2020/06/15/18/06/bears-5302684_1280.jpg",
                                words: [
                                    {"w": "Once", "s": 0.0, "e": 0.5},
                                    {"w": "upon", "s": 0.5, "e": 1.0},
                                    {"w": "a",    "s": 1.0, "e": 1.2},
                                    {"w": "time,", "s": 1.2, "e": 1.8},
                                    {"w": "there", "s": 1.8, "e": 2.2},
                                    {"w": "were", "s": 2.2, "e": 2.5},
                                    {"w": "three", "s": 2.5, "e": 3.0},
                                    {"w": "bears", "s": 3.0, "e": 3.8}
                                ]
                            },
                            {
                                text: "One morning, they made porridge for breakfast but it was too hot.",
                                start: 10.0, 
                                end: 20.0,
                                image: "https://cdn.pixabay.com/photo/2019/07/28/19/04/autumn-4369408_1280.jpg",
                                words: [
                                    {"w": "One", "s": 10.0, "e": 10.5},
                                    {"w": "morning,", "s": 10.5, "e": 11.2},
                                    {"w": "they", "s": 11.2, "e": 11.5},
                                    {"w": "made", "s": 11.5, "e": 12.0},
                                    {"w": "porridge", "s": 12.0, "e": 12.8}
                                ]
                            }
                        ]
                    }
                ];
                renderLibrary(allTales);
            }
            document.getElementById('loading-msg').style.display = 'none';
            setupSearch();
            setupAudioSync();
        }

        // 2. Render Library Grid
        function renderLibrary(tales) {
            const grid = document.getElementById('gallery-grid');
            grid.innerHTML = '';
            
            tales.forEach(tale => {
                const div = document.createElement('div');
                div.className = 'tile';
                
                // Handle image path (local vs remote)
                const imgUrl = tale.cover && !tale.cover.startsWith('http') 
                    ? `tales/${tale.id}/${tale.cover}` 
                    : (tale.cover || 'https://via.placeholder.com/300x450?text=No+Cover');
                
                let badges = '';
                if (tale.audio) badges += '<div class="badge" title="Audio">üéµ</div>';
                if (tale.youtube) badges += '<div class="badge" title="Video">üé¨</div>';

                div.innerHTML = `
                    <img src="${imgUrl}" alt="${tale.title}">
                    <div class="media-badges">${badges}</div>
                    <h3>${tale.title}</h3>
                `;
                div.onclick = () => openBook(tale);
                grid.appendChild(div);
            });
        }

        // 3. Search Functionality
        function setupSearch() {
            const searchInput = document.getElementById('search-input');
            searchInput.addEventListener('input', (e) => {
                const query = e.target.value;
                if (!query) { renderLibrary(allTales); return; }
                const fuse = new Fuse(allTales, { keys: ['title', 'author'], threshold: 0.4 });
                renderLibrary(fuse.search(query).map(r => r.item));
            });
        }

        // 4. Audio Synchronization (Karaoke Logic)
        function setupAudioSync() {
            const audioPlayer = document.getElementById('audio-player');
            let lastPageIndex = -1;

            audioPlayer.ontimeupdate = () => {
                const currentTime = audioPlayer.currentTime;
                
                // Find all pages relevant to current time
                const activePages = currentSyncData.filter(block => currentTime >= block.start && currentTime < block.end);

                if (activePages.length > 0) {
                    
                    // A. Page Turning
                    const primaryPage = activePages[0];
                    if (lastPageIndex !== primaryPage.pageIndex) {
                        lastPageIndex = primaryPage.pageIndex;
                        if (!isMobile && bookInstance) {
                            bookInstance.flip(primaryPage.pageIndex);
                        } else {
                            // Mobile scroll
                            const p = document.getElementById(`page-index-${primaryPage.pageIndex}`);
                            if(p) p.scrollIntoView({behavior:'smooth', block:'center'});
                        }
                    }

                    // B. Word Highlighting
                    activePages.forEach(pageData => {
                        const activePageEl = document.getElementById(`page-index-${pageData.pageIndex}`);
                        if (activePageEl) {
                            const spans = activePageEl.querySelectorAll('.word-span');
                            spans.forEach(span => {
                                const start = parseFloat(span.dataset.s);
                                const end = parseFloat(span.dataset.e);
                                if (currentTime >= start && currentTime < end) {
                                    span.classList.add('word-active');
                                } else {
                                    span.classList.remove('word-active');
                                }
                            });
                        }
                    });
                }
            }
        }

        // 5. Open Book & Generate HTML
        function openBook(tale) {
            // Switch views
            document.getElementById('library-view').classList.add('hidden');
            document.getElementById('reader-view').classList.remove('hidden');

            const stage = document.querySelector('.book-stage');
            const oldBook = document.getElementById('flip-book');
            if (oldBook) oldBook.remove();

            // Create new book container
            const bookEl = document.createElement('div');
            bookEl.id = 'flip-book';
            stage.appendChild(bookEl);

            // Reset state
            if (bookInstance) { bookInstance.destroy(); bookInstance = null; }
            currentSyncData = [];

            // Setup Audio
            const audioWrapper = document.getElementById('audio-controls');
            const audioPlayer = document.getElementById('audio-player');
            if (tale.audio) {
                const audioSrc = tale.audio.startsWith('http') ? tale.audio : `tales/${tale.id}/${tale.audio}`;
                audioPlayer.src = audioSrc;
                audioWrapper.classList.remove('hidden');
            } else {
                audioWrapper.classList.add('hidden');
                audioPlayer.pause();
            }

            // Setup Video Button
            const videoBtn = document.getElementById('watch-btn');
            if (tale.youtube) {
                const videoId = getYoutubeID(tale.youtube);
                if (videoId) {
                    currentVideoId = videoId;
                    videoBtn.classList.remove('hidden');
                } else { videoBtn.classList.add('hidden'); }
            } else {
                videoBtn.classList.add('hidden');
                currentVideoId = null;
            }

            // --- GENERATE PAGES ---

            // Page 0: Title Page
            const titlePage = document.createElement('div');
            titlePage.className = 'page';
            titlePage.innerHTML = `
                <div class="title-content">
                    <h1 style="font-family:'Fredoka', sans-serif; color:#6c5ce7; font-size:2.5rem; margin-top:50px;">${tale.title}</h1>
                    <p style="font-family:'Quicksand'; font-weight:bold; font-size:1.2rem; color:#b2bec3;">${tale.author || 'Folklore'}</p>
                    <div style="margin-top:auto; font-size:4rem;">ü¶Ñ</div>
                </div>`;
            bookEl.appendChild(titlePage);

            // Content Pages
            if (tale.content) {
                tale.content.forEach((item, i) => {
                    const pageIndex = i + 1;
                    const page = document.createElement('div');
                    page.className = 'page';
                    page.id = `page-index-${pageIndex}`;

                    // Store timing data for sync
                    if (item.start !== undefined) {
                        currentSyncData.push({
                            pageIndex: pageIndex,
                            start: parseFloat(item.start),
                            end: parseFloat(item.end)
                        });
                    }

                    // Handle Image Path
                    const img = item.image && !item.image.startsWith('http') 
                        ? `tales/${tale.id}/${item.image}` 
                        : item.image;
                    
                    let textHtml = '';
                    if (item.words && item.words.length > 0) {
                        // We map words to spans, then JOIN WITH A SPACE ' '
                        textHtml = item.words.map(w => 
                            `<span class="word-span" data-s="${w.s}" data-e="${w.e}">${w.w}</span>`
                        ).join(' '); 
                    } else {
                        // Fallback to plain text
                        textHtml = item.text || '';
                    }

                    // Render Page HTML
                    page.innerHTML = `
                        <div class="page-content">
                            ${img ? `<div class="page-img-box"><img src="${img}"></div>` : ''}
                            <div class="page-text">${textHtml}</div>
                            <div class="page-footer">${pageIndex}</div>
                        </div>
                    `;
                    bookEl.appendChild(page);
                });
            }

            // Add empty page if odd number (for desktop book feel)
            if (bookEl.children.length % 2 !== 0 && !isMobile) {
                const emptyPage = document.createElement('div');
                emptyPage.className = 'page';
                bookEl.appendChild(emptyPage);
            }

            // Initialize PageFlip Library (Desktop only)
            if (!isMobile) {
                const PageFlip = window.St ? window.St.PageFlip : window.PageFlip;
                bookInstance = new PageFlip(bookEl, {
                    width: 550, 
                    height: 750,
                    size: 'fixed', 
                    usePortrait: false,
                    minWidth: 300, 
                    minHeight: 400,
                    maxShadowOpacity: 0.5, 
                    showCover: false
                });
                bookInstance.loadFromHTML(bookEl.querySelectorAll('.page'));
            }
        }

        // Helper: Extract YouTube ID
        function getYoutubeID(url) {
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        }

        // Helper: Video Modal
        function openVideo() {
            if (!currentVideoId) return;
            document.getElementById('audio-player').pause();
            const modal = document.getElementById('video-modal');
            const container = document.getElementById('yt-player-container');
            container.innerHTML = `
                <iframe src="https://www.youtube.com/embed/${currentVideoId}?autoplay=1" 
                frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                allowfullscreen></iframe>
            `;
            modal.classList.remove('hidden');
        }

        function closeVideo() {
            const modal = document.getElementById('video-modal');
            const container = document.getElementById('yt-player-container');
            modal.classList.add('hidden');
            container.innerHTML = '';
        }

        // Close Reader
        function closeBook() {
            document.getElementById('reader-view').classList.add('hidden');
            document.getElementById('library-view').classList.remove('hidden');
            
            const audioPlayer = document.getElementById('audio-player');
            audioPlayer.pause();
            audioPlayer.currentTime = 0;
            currentSyncData = [];

            if (bookInstance) { bookInstance.destroy(); bookInstance = null; }
            const oldBook = document.getElementById('flip-book');
            if (oldBook) oldBook.remove();
        }

        // Navigation Controls
        function flipNext() { if(!isMobile) bookInstance?.flipNext(); }
        function flipPrev() { if(!isMobile) bookInstance?.flipPrev(); }
    </script>
</body>
</html>
